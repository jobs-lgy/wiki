<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>安装软件 | JavaChen Wiki</title>
    <meta name="description" content="JavaChen Wiki">
    <link rel="icon" href="/wiki/img/logo.ico">
  <meta http-quiv="pragma" cotent="no-cache">
  <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
  <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/wiki/assets/css/0.styles.bdf32acf.css" as="style"><link rel="preload" href="/wiki/assets/js/app.dd178f5a.js" as="script"><link rel="preload" href="/wiki/assets/js/2.9f273a62.js" as="script"><link rel="preload" href="/wiki/assets/js/54.87a1d37c.js" as="script"><link rel="prefetch" href="/wiki/assets/js/10.e389070d.js"><link rel="prefetch" href="/wiki/assets/js/11.19e9f97f.js"><link rel="prefetch" href="/wiki/assets/js/12.f95e0459.js"><link rel="prefetch" href="/wiki/assets/js/13.127730fd.js"><link rel="prefetch" href="/wiki/assets/js/14.34eed2f7.js"><link rel="prefetch" href="/wiki/assets/js/15.a8cf4000.js"><link rel="prefetch" href="/wiki/assets/js/16.6346731c.js"><link rel="prefetch" href="/wiki/assets/js/17.143af375.js"><link rel="prefetch" href="/wiki/assets/js/18.7d95703a.js"><link rel="prefetch" href="/wiki/assets/js/19.8726bd0b.js"><link rel="prefetch" href="/wiki/assets/js/20.2914a04f.js"><link rel="prefetch" href="/wiki/assets/js/21.ebd751e0.js"><link rel="prefetch" href="/wiki/assets/js/22.f6801be0.js"><link rel="prefetch" href="/wiki/assets/js/23.87ecfe73.js"><link rel="prefetch" href="/wiki/assets/js/24.cabcaf93.js"><link rel="prefetch" href="/wiki/assets/js/25.306828f5.js"><link rel="prefetch" href="/wiki/assets/js/26.59450304.js"><link rel="prefetch" href="/wiki/assets/js/27.44fddb85.js"><link rel="prefetch" href="/wiki/assets/js/28.4e15bea1.js"><link rel="prefetch" href="/wiki/assets/js/29.bed7cbfd.js"><link rel="prefetch" href="/wiki/assets/js/3.28138f41.js"><link rel="prefetch" href="/wiki/assets/js/30.36a67cca.js"><link rel="prefetch" href="/wiki/assets/js/31.dde8666e.js"><link rel="prefetch" href="/wiki/assets/js/32.148ea73a.js"><link rel="prefetch" href="/wiki/assets/js/33.61c937cc.js"><link rel="prefetch" href="/wiki/assets/js/34.eb7c4b0c.js"><link rel="prefetch" href="/wiki/assets/js/35.abb4ce3d.js"><link rel="prefetch" href="/wiki/assets/js/36.f03d0378.js"><link rel="prefetch" href="/wiki/assets/js/37.84491176.js"><link rel="prefetch" href="/wiki/assets/js/38.2a06b872.js"><link rel="prefetch" href="/wiki/assets/js/39.63965d3b.js"><link rel="prefetch" href="/wiki/assets/js/4.c0af9872.js"><link rel="prefetch" href="/wiki/assets/js/40.bf2e354a.js"><link rel="prefetch" href="/wiki/assets/js/41.bed53451.js"><link rel="prefetch" href="/wiki/assets/js/42.34d4f2f5.js"><link rel="prefetch" href="/wiki/assets/js/43.867c0e23.js"><link rel="prefetch" href="/wiki/assets/js/44.0201a314.js"><link rel="prefetch" href="/wiki/assets/js/45.d6f1a311.js"><link rel="prefetch" href="/wiki/assets/js/46.419d44e4.js"><link rel="prefetch" href="/wiki/assets/js/47.a3f8b595.js"><link rel="prefetch" href="/wiki/assets/js/48.574cc219.js"><link rel="prefetch" href="/wiki/assets/js/49.224dd6c4.js"><link rel="prefetch" href="/wiki/assets/js/5.c521f8b1.js"><link rel="prefetch" href="/wiki/assets/js/50.c8825040.js"><link rel="prefetch" href="/wiki/assets/js/51.2dab614a.js"><link rel="prefetch" href="/wiki/assets/js/52.8382a180.js"><link rel="prefetch" href="/wiki/assets/js/53.bfab18a9.js"><link rel="prefetch" href="/wiki/assets/js/55.5f207671.js"><link rel="prefetch" href="/wiki/assets/js/56.f0e8e082.js"><link rel="prefetch" href="/wiki/assets/js/57.c868e5c9.js"><link rel="prefetch" href="/wiki/assets/js/6.6a737c5b.js"><link rel="prefetch" href="/wiki/assets/js/7.48bba6b4.js"><link rel="prefetch" href="/wiki/assets/js/8.26532964.js"><link rel="prefetch" href="/wiki/assets/js/9.3c4a4032.js">
    <link rel="stylesheet" href="/wiki/assets/css/0.styles.bdf32acf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/wiki/" class="home-link router-link-active"><!----> <span class="site-name">JavaChen Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/wiki/" class="nav-link">主页</a></div><div class="nav-item"><a href="/wiki/docker/" class="nav-link">Docker</a></div><div class="nav-item"><a href="/wiki/elasticsearch/" class="nav-link">Elasticsearch</a></div><div class="nav-item"><a href="/wiki/hadoop/" class="nav-link">Hadoop</a></div><div class="nav-item"><a href="/wiki/interview/" class="nav-link">Interview</a></div><div class="nav-item"><a href="/wiki/rabbitMQ/" class="nav-link">RabbitMQ</a></div><div class="nav-item"><a href="/wiki/redis/" class="nav-link">Redis</a></div><div class="nav-item"><a href="/wiki/spring-cloud-cshop/" class="nav-link router-link-active">Spring-cloud-cshop</a></div><div class="nav-item"><a href="/wiki/about.html" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/wiki/" class="nav-link">主页</a></div><div class="nav-item"><a href="/wiki/docker/" class="nav-link">Docker</a></div><div class="nav-item"><a href="/wiki/elasticsearch/" class="nav-link">Elasticsearch</a></div><div class="nav-item"><a href="/wiki/hadoop/" class="nav-link">Hadoop</a></div><div class="nav-item"><a href="/wiki/interview/" class="nav-link">Interview</a></div><div class="nav-item"><a href="/wiki/rabbitMQ/" class="nav-link">RabbitMQ</a></div><div class="nav-item"><a href="/wiki/redis/" class="nav-link">Redis</a></div><div class="nav-item"><a href="/wiki/spring-cloud-cshop/" class="nav-link router-link-active">Spring-cloud-cshop</a></div><div class="nav-item"><a href="/wiki/about.html" class="nav-link">关于</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spring-cloud-cshop</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/wiki/spring-cloud-cshop/" class="sidebar-link">项目简介</a></li><li><a href="/wiki/spring-cloud-cshop/cshop-1-技术架构.html" class="sidebar-link">技术架构</a></li><li><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html" class="active sidebar-link">安装软件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装docker" class="sidebar-link">安装Docker</a></li><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装nexus" class="sidebar-link">安装Nexus</a></li><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装gitlab" class="sidebar-link">安装GItlab</a></li><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装gitlab-runner" class="sidebar-link">安装GitLab Runner</a></li><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装gogs" class="sidebar-link">安装gogs</a></li><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装jenkins" class="sidebar-link">安装Jenkins</a></li><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装mysql" class="sidebar-link">安装MySQL</a></li><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装redis" class="sidebar-link">安装Redis</a></li><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装rabbitmq" class="sidebar-link">安装RabbitMQ</a></li><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装nginx" class="sidebar-link">安装Nginx</a></li><li class="sidebar-sub-header"><a href="/wiki/spring-cloud-cshop/cshop-2-安装软件.html#安装elasticsearch" class="sidebar-link">安装ElasticSearch</a></li></ul></li><li><a href="/wiki/spring-cloud-cshop/cshop-3-准备开发环境.html" class="sidebar-link">准备开发环境</a></li><li><a href="/wiki/spring-cloud-cshop/cshop-4-功能模块.html" class="sidebar-link">功能模块</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="安装软件"><a href="#安装软件" aria-hidden="true" class="header-anchor">#</a> 安装软件</h1> <h2 id="安装docker"><a href="#安装docker" aria-hidden="true" class="header-anchor">#</a> 安装Docker</h2> <p>请参考 <a href="/wiki/docker/">Docker</a></p> <h2 id="安装nexus"><a href="#安装nexus" aria-hidden="true" class="header-anchor">#</a> 安装Nexus</h2> <h3 id="docker安装"><a href="#docker安装" aria-hidden="true" class="header-anchor">#</a> docker安装</h3> <p>1、下载镜像</p> <div class="language- extra-class"><pre class="language-text"><code>docker pull sonatype/nexus3  
</code></pre></div><p>2、将容器内部/var/nexus-data挂载到主机/data/docker/nexus/data目录</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -d -p 4070:8081 --name nexus -v /data/docker/nexus/data:/var/nexus-data sonatype/nexus3
</code></pre></div><p>3、开放端口</p> <div class="language- extra-class"><pre class="language-text"><code>firewall-cmd --zone=public --add-port=4070/tcp --permanent
</code></pre></div><p>4、访问http://192.168.56.100:4070 ，Maven私服启动容器稍微比较慢，等待1分钟即可，默认登陆账号 admin，密码如果admin123不行，则查看 /data/docker/nexus/data/admin.password</p> <div class="language- extra-class"><pre class="language-text"><code>docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
50fb70de8f66        sonatype/nexus3     &quot;sh -c ${SONATYPE_DI…&quot;   3 minutes ago       Up 3 minutes        0.0.0.0:4070-&gt;8081/tcp   nexus
</code></pre></div><p>5、查看日志：</p> <div class="language- extra-class"><pre class="language-text"><code>docker logs -f nexus
</code></pre></div><h3 id="docker-compose安装"><a href="#docker-compose安装" aria-hidden="true" class="header-anchor">#</a> docker-compose安装</h3> <p>docker-compose.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nexus</span><span class="token punctuation">:</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> sonatype/nexus3
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nexus
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 4070<span class="token punctuation">:</span><span class="token number">8081</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/nexus/data<span class="token punctuation">:</span>/nexus<span class="token punctuation">-</span>data
</code></pre></div><p>出现异常：</p> <div class="language- extra-class"><pre class="language-text"><code>java.io.FileNotFoundException: ../sonatype-work/nexus3/tmp/i4j_ZTDnGON8hezynsMX2ZCYAVDtQog=.lock (No such file or directory)
</code></pre></div><p>目录权限问题，修改为757后正常启动：</p> <div class="language- extra-class"><pre class="language-text"><code>chmod 757 /data/docker/nexus/data/
</code></pre></div><p>另外一种推荐做法是，使用容器挂载数据比较不容易出现文件权限的问题。</p> <div class="language- extra-class"><pre class="language-text"><code>docker volume create --name nexus-data
</code></pre></div><p>然后修改docker-compose.yml：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nexus</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> sonatype/nexus3
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nexus
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 4070<span class="token punctuation">:</span><span class="token number">8081</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> data<span class="token punctuation">:</span>/nexus<span class="token punctuation">-</span>data

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
</code></pre></div><h3 id="使用"><a href="#使用" aria-hidden="true" class="header-anchor">#</a> 使用</h3> <p><strong>1、创建私服仓库</strong></p> <p>创建仓库，点击Create repository，然后选择maven2(hosted)然后输入仓库名称 nexus-release。在version policy中选择这个仓库的类型，这里选择release，在Deployment policy中选择Allow redeploy（这个很重要）.</p> <p><strong>2、创建私服账号</strong></p> <p>点击左侧菜单栏的Users菜单，然后点击Create local user，我这里创建了一个用户，账号密码都是：test</p> <p>本地settings.xml</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servers</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>nexus-releases<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span>admin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>admin123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>nexus-snapshots<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span>admin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>admin123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servers</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Snapshots 与 Releases 的区别</p> <ul><li>nexus-releases: 用于发布 Release 版本</li> <li>nexus-snapshots: 用于发布 Snapshot 版本（快照版）</li></ul> <p>Release 版本与 Snapshot 定义如下：</p> <div class="language- extra-class"><pre class="language-text"><code>Release: 1.0.0/1.0.0-RELEASE
Snapshot: 1.0.0-SNAPSHOT
</code></pre></div><ul><li>在项目 pom.xml 中设置的版本号添加 SNAPSHOT 标识的都会发布为 SNAPSHOT 版本，没有 SNAPSHOT 标识的都会发布为 RELEASE 版本。</li> <li>SNAPSHOT 版本会自动加一个时间作为标识，如：1.0.0-SNAPSHOT 发布后为变成 1.0.0-SNAPSHOT-20180522.123456-1.jar</li></ul> <p><strong>3、创建一个Maven工程</strong></p> <p>创建一个maven工程，并且打包到maven私服。</p> <p>相关配置</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>distributionManagement</span><span class="token punctuation">&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>nexus-releases<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Nexus Release Repository<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>http://192.168.56.100:4070/repository/nexus-releases/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshotRepository</span><span class="token punctuation">&gt;</span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>nexus-snapshots<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Nexus Snapshot Repository<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>http://192.168.56.100:4070/repository/nexus-snapshots/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshotRepository</span><span class="token punctuation">&gt;</span></span>  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>distributionManagement</span><span class="token punctuation">&gt;</span></span> 

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--发布代码Jar插件 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-deploy-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--发布源码插件 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-source-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>jar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>注意事项：</p> <ul><li>ID 名称必须要与 settings.xml 中 Servers 配置的 ID 名称保持一致。</li> <li>项目版本号中有 SNAPSHOT 标识的，会发布到 Nexus Snapshots Repository, 否则发布到 Nexus Release Repository，并根据 ID 去匹配授权账号。</li></ul> <p><strong>4、部署jar包：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>mvn deploy
</code></pre></div><p><strong>5、上传第三方 JAR 包</strong></p> <p>Nexus 3.0 不支持页面上传，可使用 maven 命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 如第三方JAR包：aliyun-sdk-oss-2.2.3.jar</span>
mvn deploy:deploy-file 
  -DgroupId<span class="token operator">=</span>com.aliyun.oss 
  -DartifactId<span class="token operator">=</span>aliyun-sdk-oss 
  -Dversion<span class="token operator">=</span>2.2.3 
  -Dpackaging<span class="token operator">=</span>jar 
  -Dfile<span class="token operator">=</span>~/aliyun-sdk-oss-2.2.3.jar 
  -Durl<span class="token operator">=</span>http://192.168.56.100:8081/repository/nexus-releases/ 
  -DrepositoryId<span class="token operator">=</span>nexus-releases
</code></pre></div><p>注意事项：</p> <ul><li>建议在上传第三方 JAR 包时，创建单独的第三方 JAR 包管理仓库，便于管理有维护。（maven-3rd）</li> <li>-DrepositoryId=nexus-releases 对应的是 settings.xml 中 Servers 配置的 ID 名称。（授权）</li></ul> <p><strong>5、配置代理仓库</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>nexus-releases<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Nexus Repository<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>http://192.168.56.100:4070/repository/nexus-releases/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>releases</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>releases</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepositories</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>nexus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Nexus Plugin Repository<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>http://192.168.56.100:4070/repository/nexus-releases/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>releases</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>releases</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepositories</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="安装gitlab"><a href="#安装gitlab" aria-hidden="true" class="header-anchor">#</a> 安装GItlab</h2> <p>GitLab 是利用 Ruby on Rails 一个开源的版本管理系统，实现一个自托管的 Git 项目仓库，可通过 Web 界面进行访问公开的或者私人项目。它拥有与 Github 类似的功能，能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。团队成员可以利用内置的简单聊天程序 (Wall) 进行交流。它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找。</p> <h3 id="yum安装"><a href="#yum安装" aria-hidden="true" class="header-anchor">#</a> yum安装</h3> <h4 id="配置yum源"><a href="#配置yum源" aria-hidden="true" class="header-anchor">#</a> 配置yum源</h4> <p>/etc/yum.repos.d/gitlab-ce.repo</p> <div class="language- extra-class"><pre class="language-text"><code>[gitlab-ce]
name=Gitlab CE Repository
baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/
gpgcheck=0
enabled=1
</code></pre></div><h4 id="安装gitlab社区版"><a href="#安装gitlab社区版" aria-hidden="true" class="header-anchor">#</a> 安装GitLab社区版</h4> <div class="language- extra-class"><pre class="language-text"><code>yum install -y gitlab-ce
</code></pre></div><h4 id="gitlab常用命令"><a href="#gitlab常用命令" aria-hidden="true" class="header-anchor">#</a> GitLab常用命令</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> gitlab-ctl start    <span class="token comment"># 启动所有 gitlab 组件；</span>
<span class="token function">sudo</span> gitlab-ctl stop        <span class="token comment"># 停止所有 gitlab 组件；</span>
<span class="token function">sudo</span> gitlab-ctl restart        <span class="token comment"># 重启所有 gitlab 组件；</span>
<span class="token function">sudo</span> gitlab-ctl status        <span class="token comment"># 查看服务状态；</span>
<span class="token function">sudo</span> gitlab-ctl reconfigure        <span class="token comment"># 启动服务；</span>
<span class="token function">sudo</span> <span class="token function">vim</span> /etc/gitlab/gitlab.rb        <span class="token comment"># 修改默认的配置文件；</span>
gitlab-rake gitlab:check SANITIZE<span class="token operator">=</span>true --trace    <span class="token comment"># 检查gitlab；</span>
<span class="token function">sudo</span> gitlab-ctl <span class="token function">tail</span>        <span class="token comment"># 查看日志；</span>
</code></pre></div><h4 id="修改配置文件"><a href="#修改配置文件" aria-hidden="true" class="header-anchor">#</a> 修改配置文件</h4> <p>/etc/gitlab/gitlab.rb</p> <div class="language- extra-class"><pre class="language-text"><code>external_url 'http://192.168.56.100:4080'
gitlab_rails['time_zone'] = 'Asia/Shanghai'
gitlab_rails['gitlab_shell_ssh_port'] = 4022
unicorn['listen'] = '192.168.56.100'
</code></pre></div><h4 id="汉化（可选）"><a href="#汉化（可选）" aria-hidden="true" class="header-anchor">#</a> 汉化（可选）</h4> <p>下载最新的汉化包</p> <div class="language- extra-class"><pre class="language-text"><code>git clone https://gitlab.com/xhang/gitlab.git
</code></pre></div><p>查看该汉化补丁的版本</p> <div class="language- extra-class"><pre class="language-text"><code>cd gitlab
cat VERSION
</code></pre></div><p>查看gitlab版本</p> <div class="language- extra-class"><pre class="language-text"><code>head -1 /opt/gitlab/version-manifest.txt
</code></pre></div><p>比较汉化标签和原标签，导出 patch 用的 diff 文件到/root下</p> <div class="language- extra-class"><pre class="language-text"><code>git diff v12.0.3 v12.0.3-zh &gt; ../12.0.3-zh.diff
</code></pre></div><p>打补丁：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> patch -y 

patch -d /opt/gitlab/embedded/service/gitlab-rails -p1 <span class="token operator">&lt;</span> 12.0.3-zh.diff
</code></pre></div><h4 id="配置gitlab"><a href="#配置gitlab" aria-hidden="true" class="header-anchor">#</a> 配置gitlab</h4> <p>内存不够，我先加 swap空间</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cd</span> /mnt/swap/
<span class="token function">dd</span> if<span class="token operator">=</span>/dev/zero of<span class="token operator">=</span>swapfile bs<span class="token operator">=</span>1M count<span class="token operator">=</span>9999 
<span class="token function">mkswap</span> swapfile
<span class="token function">swapon</span> swapfile
</code></pre></div><p>添加开机自动挂</p> <div class="language- extra-class"><pre class="language-text"><code>vim /etc/fstab 
/mnt/swap/swapfile swap swap defaults 0 0
</code></pre></div><p>查看：</p> <div class="language- extra-class"><pre class="language-text"><code>top -c
</code></pre></div><p>设置让系统积极使用swap空间：</p> <div class="language- extra-class"><pre class="language-text"><code>echo 100 &gt; /proc/sys/vm/swappiness
</code></pre></div><p>sysctl -p 或者重启生效</p> <div class="language- extra-class"><pre class="language-text"><code>sysctl -p
</code></pre></div><p>配置gitlab：</p> <div class="language- extra-class"><pre class="language-text"><code>gitlab-ctl reconfigure
</code></pre></div><h4 id="启动gitlab"><a href="#启动gitlab" aria-hidden="true" class="header-anchor">#</a> 启动gitlab</h4> <div class="language- extra-class"><pre class="language-text"><code>gitlab-ctl start
</code></pre></div><h4 id="测试"><a href="#测试" aria-hidden="true" class="header-anchor">#</a> 测试</h4> <p>访问http://192.168.56.100:4080/，设置登陆密码为admin123，登陆用户为root。</p> <h4 id="设置"><a href="#设置" aria-hidden="true" class="header-anchor">#</a> 设置</h4> <p>第一次使用时需要做一些初始化设置，点击“管理区域”--&gt;“设置”，账户与限制设置：关闭头像功能，由于 Gravatar 头像为网络头像，在网络情况不理想时可能导致访问时卡顿</p> <p>由于是内部代码托管服务器，可以直接关闭注册功能，由管理员统一创建用户即可</p> <h3 id="docker安装-2"><a href="#docker安装-2" aria-hidden="true" class="header-anchor">#</a> docker安装</h3> <blockquote><p>说明：用root安装</p></blockquote> <p>1、下载镜像文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker pull docker.io/gitlab/gitlab-ce-zh
</code></pre></div><p>2、  创建目录</p> <p>将GitLab 的配置 (etc) 、 日志 (log) 、数据 (data) 放到容器之外， 便于日后升级， 因此请先准备这三个目录。</p> <div class="language- extra-class"><pre class="language-text"><code>mkdir -p /data/docker/gitlab/conf
mkdir -p /data/docker/gitlab/logs
mkdir -p /data/docker/gitlab/data
</code></pre></div><p>3、运行容器</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -d --network <span class="token string">&quot;host&quot;</span> -p 4022:22 -p 4443:443 -p 4080:80  \
	-v /data/docker/gitlab/etc:/etc/gitlab \
	-v /data/docker/gitlab/logs:/var/log/gitlab \
	-v /data/docker/gitlab/data:/var/opt/gitlab \
	-v /etc/localtime:/etc/localtime:ro \
	--name gitlab docker.io/twang2218/gitlab-ce-zh
</code></pre></div><p>4、修改配置文件</p> <p>进入容器修改配置文件：</p> <div class="language- extra-class"><pre class="language-text"><code>docker exec -it gitlab vim /etc/gitlab/gitlab.rb
</code></pre></div><p>修改以下配置：</p> <div class="language- extra-class"><pre class="language-text"><code>external_url 'http://192.168.56.100:4080'

gitlab_rails['gitlab_ssh_host'] = '192.168.56.100'
gitlab_rails['gitlab_shell_ssh_port'] = 4022
gitlab_rails['time_zone'] = 'Asia/Shanghai'
</code></pre></div><p>修改<code>/data/docker/gitlab/data/gitlab-rails/etc/gitlab.yml</code>，找到关键字<code>* ## Web server settings *</code> ，将host的值改成映射的外部主机IP地址 <code>192.168.56.100</code>，这里会显示在gitlab克隆地址。</p> <div class="language-yml extra-class"><pre class="language-yml"><code>  <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
    <span class="token comment">## Web server settings (note: host is the FQDN, do not include http://)</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.56.100
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">4080</span>
    <span class="token key atrule">https</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre></div><p>重启容器：</p> <div class="language- extra-class"><pre class="language-text"><code>docker restart gitlab
</code></pre></div><p>查看日志：</p> <div class="language- extra-class"><pre class="language-text"><code>docker logs -f gitlab

</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>firewall-cmd --zone=public --add-port=8380/tcp --permanent
</code></pre></div><p>5、测试</p> <p>访问 http://192.168.56.100:4080，修改默认密码为<code>admin123</code>，然后再以root用户登陆。</p> <p>创建项目，然后再克隆代码进行测试。</p> <blockquote><p>问题：ssh端口映射失败，ssh协议暂时用不了。</p></blockquote> <h3 id="docker-compose安装-2"><a href="#docker-compose安装-2" aria-hidden="true" class="header-anchor">#</a> docker-compose安装</h3> <p>我们使用 Docker 来安装和运行 GitLab 中文版，由于新版本问题较多，这里我们使用目前相对稳定的 10.5 版本，<code>docker-compose.yml</code> 配置如下：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
    <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'gitlab/gitlab-ce'</span>
      <span class="token key atrule">container_name</span><span class="token punctuation">:</span> <span class="token string">&quot;gitlab&quot;</span>
      <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped
      <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">hostname</span><span class="token punctuation">:</span> <span class="token string">'gitlab.javachen.com'</span>
      <span class="token key atrule">environment</span><span class="token punctuation">:</span>
        <span class="token key atrule">TZ</span><span class="token punctuation">:</span> <span class="token string">'Asia/Shanghai'</span>
        <span class="token key atrule">GITLAB_OMNIBUS_CONFIG</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          external_url 'http://gitlab.javachen.com:4080'
          gitlab_rails['time_zone'] = 'Asia/Shanghai'
          gitlab_rails['gitlab_shell_ssh_port'] = 4022</span>
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">'4080:8080'</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /data/docker/gitlab/conf<span class="token punctuation">:</span>/etc/gitlab
        <span class="token punctuation">-</span> /data/docker/gitlab/data<span class="token punctuation">:</span>/var/opt/gitlab
        <span class="token punctuation">-</span> /data/docker/gitlab/logs<span class="token punctuation">:</span>/var/log/gitlab
      <span class="token key atrule">extra_hosts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;gitlab.javachen.com:192.168.56.100&quot;</span>

</code></pre></div><p>后台运行：</p> <div class="language- extra-class"><pre class="language-text"><code>docker-compose up -d
</code></pre></div><h2 id="安装gitlab-runner"><a href="#安装gitlab-runner" aria-hidden="true" class="header-anchor">#</a> 安装GitLab Runner</h2> <h3 id="yum安装-2"><a href="#yum安装-2" aria-hidden="true" class="header-anchor">#</a> yum安装</h3> <div class="language- extra-class"><pre class="language-text"><code>curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.rpm.sh | sudo bash

yum install gitlab-ci-multi-runner -y
</code></pre></div><p>注册：</p> <div class="language-text extra-class"><pre class="language-text"><code>gitlab-ci-multi-runner register
</code></pre></div><p>说明：</p> <ul><li>gitlab-ci-multi-runner register：执行注册命令</li> <li>Please enter the gitlab-ci coordinator URL：输入 ci 地址</li> <li>Please enter the gitlab-ci token for this runner：输入 ci token</li> <li>Please enter the gitlab-ci description for this runner：输入 runner 名称</li> <li>Please enter the gitlab-ci tags for this runner：设置 tag</li> <li>Whether to run untagged builds：这里选择 true ，代码上传后会能够直接执行</li> <li>Whether to lock Runner to current project：直接回车，不用输入任何口令</li> <li>Please enter the executor：选择 runner 类型，这里我们选择的是 shell</li></ul> <p>CI 的地址和令牌，在<strong>创建的项目</strong>的项目 --&gt; 设置 --&gt; CI/CD --&gt; Runner 设置：</p> <p>为保证能够正常集成，我们还需要一些其它配置：</p> <ul><li>安装完 GitLab Runner 后系统会增加一个 gitlab-runner 账户，我们将它加进 root 组：</li></ul> <div class="language-text extra-class"><pre class="language-text"><code>gpasswd -a gitlab-runner root
</code></pre></div><ul><li>配置需要操作目录的权限，比如你的 runner 要在 gaming 目录下操作：</li></ul> <div class="language-text extra-class"><pre class="language-text"><code>chmod 775 gaming

</code></pre></div><ul><li>由于我们的 shell 脚本中有执行 git pull 的命令，我们直接设置以 ssh 方式拉取代码：</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">su</span> gitlab-runner
ssh-keygen -t rsa -C <span class="token string">&quot;你在 GitLab 上的邮箱地址&quot;</span>
<span class="token function">cd</span> 
<span class="token function">cd</span> .ssh
<span class="token function">cat</span> id_rsa.pub
</code></pre></div><ul><li>复制 id_rsa.pub 中的秘钥到 GitLab：</li></ul> <p>删除注册信息：</p> <div class="language-text extra-class"><pre class="language-text"><code>gitlab-ci-multi-runner unregister --name &quot;名称&quot;
</code></pre></div><p>查看注册列表：</p> <div class="language-text extra-class"><pre class="language-text"><code>gitlab-ci-multi-runner list
</code></pre></div><h3 id="docker安装-3"><a href="#docker安装-3" aria-hidden="true" class="header-anchor">#</a> docker安装</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -d --name gitlab-runner --restart always \
   -v /var/run/docker.sock:/var/run/docker.sock \
   --network<span class="token operator">=</span>gitlab_net \
   --add-host<span class="token operator">=</span>gitlab.javachen.com:192.168.56.100 \
   gitlab/gitlab-runner
</code></pre></div><h3 id="docker-compose安装-3"><a href="#docker-compose安装-3" aria-hidden="true" class="header-anchor">#</a> docker-compose安装</h3> <ul><li>创建工作目录 <code>/data/docker/runner</code></li> <li>创建构建目录 <code>/data/docker/runner/environment</code></li></ul> <p>在 <code>/usr/local/docker/runner</code> 目录下创建 <code>docker-compose.yml</code></p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.1&quot;</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">runner</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'gitlab/gitlab-runner:latest'</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> <span class="token string">'gitlab-runner'</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'/data/gitlab-runner/conf:/etc/gitlab-runner'</span>
      <span class="token punctuation">-</span> <span class="token string">'/var/run/docker.sock:/var/run/docker.sock'</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> gitlab_net
    <span class="token key atrule">extra_hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;gitlab.javachen.com:192.168.56.100&quot;</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">gitlab_net</span><span class="token punctuation">:</span>
    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>注册：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker <span class="token function">exec</span> -it gitlab-runner gitlab-runner register
</code></pre></div><h2 id="安装gogs"><a href="#安装gogs" aria-hidden="true" class="header-anchor">#</a> 安装gogs</h2> <div class="language- extra-class"><pre class="language-text"><code>docker run -d --name=gogs -p 3022:22 -p 3000:3000 -e TZ=Asia/Shanghai -v /data/docker/gogs:/data gogs/gogs
</code></pre></div><h2 id="安装jenkins"><a href="#安装jenkins" aria-hidden="true" class="header-anchor">#</a> 安装Jenkins</h2> <h3 id="什么是-jenkins"><a href="#什么是-jenkins" aria-hidden="true" class="header-anchor">#</a> 什么是 Jenkins</h3> <p><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g5ax5v4oebj30b203kjrl.jpg" alt="img"></p> <p>Jenkins 是一个开源软件项目，是基于 Java 开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件的持续集成变成可能。</p> <p>官方网站：https://jenkins.io/</p> <h3 id="docker-安装-jenkins"><a href="#docker-安装-jenkins" aria-hidden="true" class="header-anchor">#</a> Docker 安装 Jenkins</h3> <h4 id="docker-compose"><a href="#docker-compose" aria-hidden="true" class="header-anchor">#</a> docker-compose</h4> <p>Jenkins 是一个简单易用的持续集成软件平台，我们依然采用 Docker 的方式部署，<code>docker-compose.yml</code> 配置文件如下：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">jenkins</span><span class="token punctuation">:</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> jenkinsci/jenkins
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> jenkins
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 4090<span class="token punctuation">:</span><span class="token number">8080</span>
      <span class="token comment"># 基于 JNLP 的 Jenkins 代理通过 TCP 端口 50000 与 Jenkins master 进行通信</span>
      <span class="token punctuation">-</span> 4091<span class="token punctuation">:</span><span class="token number">50000</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">TZ</span><span class="token punctuation">:</span> Asia/Shanghai
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/jenkins<span class="token punctuation">:</span>/var/jenkins_home
</code></pre></div><p>访问jenkins地址 http://192.168.56.100:4090 ，注意：第一次启动的时候正在加载jenkins大概会等待3-10分钟。</p> <p>安装过程中会出现 Docker 数据卷 权限问题，用以下命令解决：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">chown</span> -R 1000 /usr/local/docker/jenkins/data
</code></pre></div><p>Jenkins 第一次启动时需要输入一个初始密码用以解锁安装流程，使用 <code>docker logs jenkins</code> 即可方便的查看到初始密码：</p> <div class="language- extra-class"><pre class="language-text"><code>Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:
58b7075d4576491d860a902f250698d2
This may also be found at: /var/jenkins_home/secrets/initialAdminPassword
</code></pre></div><p>或者进入容器查看：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker <span class="token function">exec</span> -it jenkins /bin/bash 

<span class="token function">cat</span> /var/jenkins_home/secrets/initialAdminPassword
</code></pre></div><p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g5ax7f84bkj30yh0nqgmz.jpg" alt="img"></p> <h4 id="使用自定义插件的方式安装"><a href="#使用自定义插件的方式安装" aria-hidden="true" class="header-anchor">#</a> 使用自定义插件的方式安装</h4> <p>插件是 Jenkins 的核心，其丰富的插件（截止到 <code>2018.10.29</code> 共有 <code>77350</code> 个插件）可以满足不同人群的不同需求</p> <p>插件地址：https://plugins.jenkins.io/</p> <p><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g5ax8any5qj30ye0nq40x.jpg" alt="img"></p> <p><strong>注意：</strong> 除了默认勾选的插件外，一定要勾选 <code>Publish over SSH</code> 插件，这是我们实现持续交付的重点插件。</p> <p><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g5ax8clqahj30yh0nrtbp.jpg" alt="img"></p> <p><strong>开始安装了，根据网络情况，安装时间可能会比较长，请耐心等待</strong></p> <p><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g5ax8edn00j30yg0nuabt.jpg" alt="img"></p> <p><strong>很多插件装不上怎么办？不要慌，记住这些插件的名字，咱们稍后可以手动安装</strong></p> <p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g5ax8f8pl4j30yh0npjti.jpg" alt="img"></p> <p>安装成功之后，创建用户名和密码 admin/admin123</p> <h3 id="配置-jenkins"><a href="#配置-jenkins" aria-hidden="true" class="header-anchor">#</a> 配置 Jenkins</h3> <h4 id="配置-jdk-maven"><a href="#配置-jdk-maven" aria-hidden="true" class="header-anchor">#</a> 配置 JDK &amp; Maven</h4> <p>上传 JDK 和 Maven 的 tar 包到服务器（容器数据卷目录）</p> <p><strong>打开Jenkins的 主页面 &gt; 系统管理 &gt; Global Tool Configuration</strong>：</p> <ul><li>安装 JDK（<code>JAVA_HOME</code> <strong>的路径是宿主机目录，切记！</strong>）</li></ul> <div class="language-text extra-class"><pre class="language-text"><code>/var/jenkins_home/jdk1.8.0_152
</code></pre></div><p><img src="http://ww1.sinaimg.cn/large/006tNc79gy1g5axa0tf6kj314b09owel.jpg" alt="img"></p> <ul><li>安装 Maven（<code>MAVEN_HOME</code> <strong>的路径是宿主机目录，切记！</strong>）</li></ul> <div class="language-text extra-class"><pre class="language-text"><code>/var/jenkins_home/apache-maven-3.5.3
</code></pre></div><p><img src="http://ww1.sinaimg.cn/large/006tNc79gy1g5axa1arnej314q09b74f.jpg" alt="img"></p> <ul><li>设置Git的路径</li></ul> <h4 id="配置本地化（显示中文）"><a href="#配置本地化（显示中文）" aria-hidden="true" class="header-anchor">#</a> 配置本地化（显示中文）</h4> <ul><li>安装 <code>Locale</code> 插件</li></ul> <p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g5axa1p3k0j315b07ht8u.jpg" alt="img"></p> <ul><li><code>Manage Jenkins</code> -&gt; <code>Configure System</code> -&gt; <code>Locale</code></li></ul> <p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g5axa2dkp3j314n03eq2u.jpg" alt="img"></p> <ul><li>本地化效果图</li></ul> <p><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g5axa3onmgj30cl0gogm5.jpg" alt="img"></p> <h4 id="安装动态参数插件"><a href="#安装动态参数插件" aria-hidden="true" class="header-anchor">#</a> 安装动态参数插件</h4> <p>该插件的主要目的是为了方便我们后面在做项目构建时可以按照版本进行构建（支持一键回滚哦）</p> <p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g5axa36virj314x0fymxy.jpg" alt="img"></p> <h4 id="jenkins配置构建远程服务器"><a href="#jenkins配置构建远程服务器" aria-hidden="true" class="header-anchor">#</a> Jenkins配置构建远程服务器</h4> <ul><li>交互式进入 Jenkins 容器</li></ul> <div class="language-text extra-class"><pre class="language-text"><code>docker exec -it jenkins /bin/bash
</code></pre></div><ul><li>生成 SSH KEY</li></ul> <div class="language-text extra-class"><pre class="language-text"><code>ssh-keygen -f jenkins
</code></pre></div><ul><li>查看公钥</li></ul> <div class="language-text extra-class"><pre class="language-text"><code>cat ~/.ssh/jenkins.pub
</code></pre></div><ul><li>复制公钥到 GitLab</li></ul> <p>登录服务器192.168.56.100将Jenkins生成的公钥加入authorized_keys</p> <div class="language- extra-class"><pre class="language-text"><code>vim  ~/.ssh/authorized_keys
</code></pre></div><ul><li>jenkins配置 Publish Over SSH</li></ul> <p><strong>进入Jenkins平台，点击 系统管理 -&gt; 系统设置 -&gt; 找到 Publish Over SSH 配置项</strong></p> <div class="language- extra-class"><pre class="language-text"><code># 查看并拷贝jenkins的私钥

cat ~/.ssh/jenkins
</code></pre></div><ul><li><code>系统管理</code> -&gt; <code>系统设置</code> -&gt; <code>Publish over SSH</code></li></ul> <p><strong>注：Jenkins SSH Key 这一栏默认会使用Jenkins管理员admin账户的密码，可以不填则设置为空密码</strong></p> <p>在key一栏填入拷贝的jenkins的私钥。</p> <p>SSH Server的hostname填 192.168.56.100，username填root</p> <p>其中 <code>Remote Directory</code> 是指 Jenkins 可以在目标服务器操作的目录，填/usr/local/jenkins</p> <ul><li>测试是否能够正常通信</li></ul> <p><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g5axe5q7u1j30s60i70t7.jpg" alt="img"></p> <h3 id="创建项目"><a href="#创建项目" aria-hidden="true" class="header-anchor">#</a> 创建项目</h3> <p>1、创建test项目</p> <p><img src="http://ww1.sinaimg.cn/large/006tNc79gy1g5b086c4hpj30vg0lmq4r.jpg" alt="img"></p> <p><strong>其它配置项先默认即可</strong></p> <p>2、进入jenkins平台打开 系统管理 -&gt; 管理插件 -&gt; 可选插件，在右上角输入框中输入&quot;gogs&quot;来筛选插件：</p> <p><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g5b0efwtxyj318k0as0tb.jpg" alt="img"></p> <p>3、gogs中仓库配置</p> <p>创建一个test仓库，点击仓库设置，<strong>点击 管理Web钩子 -&gt; 添加Web钩子 -&gt; 选择Gogs</strong>，添加下面钩子：</p> <div class="language- extra-class"><pre class="language-text"><code>http://192.168.56.100:4090/gogs-webhook/?job=test
</code></pre></div><p>4、点击 推送测试，如 成功 会看到下推送记录</p> <p>5、项目Git项相关配置：</p> <p><strong>打开项目（test）配置页</strong>，配置Git仓库</p> <p>http://192.168.56.100:3000/june/test</p> <p>6、建构触发器配置</p> <p>7、构建项配置</p> <p><strong>最核心的一步，选择&quot;Send files or execute commands over SSH&quot;</strong></p> <p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g5b1nfwvu0j30wa0mqabb.jpg" alt="img"></p> <p>8、推送自动构建测试</p> <p><strong>Gogs上关联的仓库（test）master分支下push一条修改记录后，会发现jenkins上自动完成本地push的远程构建</strong></p> <p>参考文章：</p> <p>https://www.jianshu.com/p/14e356cf8bb4</p> <h2 id="安装mysql"><a href="#安装mysql" aria-hidden="true" class="header-anchor">#</a> 安装MySQL</h2> <h3 id="使用docker安装"><a href="#使用docker安装" aria-hidden="true" class="header-anchor">#</a> 使用Docker安装</h3> <p>下载镜像：</p> <div class="language- extra-class"><pre class="language-text"><code>docker pull mysql
</code></pre></div><p>运行容器：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -d -p 3306:3306  \
  -v /data/docker/mysql/conf:/etc/mysql \
  -v /data/docker/mysql/logs:/var/log/mysql \
  -v /data/docker/mysql/data:/var/lib/mysql \
  -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>123456 \
  --name mysql mysql
</code></pre></div><p>命令参数：</p> <ul><li><code>-p 3306:3306</code>：将容器的3306端口映射到主机的3306端口</li> <li><code>-v /data/docker/mysql/conf:/etc/mysql</code>：将主机当前目录下的 conf 挂载到容器的 /etc/mysql</li> <li><code>-v /data/docker/mysql/logs:/var/log/mysql</code>：将主机当前目录下的 logs 目录挂载到容器的 /var/log/mysql</li> <li><code>-v /data/docker/mysql/data:/var/lib/mysql</code>：将主机当前目录下的 data 目录挂载到容器的 /var/lib/mysql</li> <li><code>-e MYSQL_ROOT_PASSWORD=123456</code>：初始化root用户的密码</li></ul> <p>查看容器启动情况：</p> <div class="language- extra-class"><pre class="language-text"><code>docker ps
</code></pre></div><p>防火墙开启3306端口</p> <div class="language- extra-class"><pre class="language-text"><code>firewall-cmd --add-port=3306/tcp

firewall-cmd --zone=public --add-port=3306/tcp --permanent
</code></pre></div><p>/data/docker/mysql/conf下创建my.cnf</p> <div class="language- extra-class"><pre class="language-text"><code>[client]
default-character-set=utf8mb4

[mysqld]
character-set-client-handshake = FALSE
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci


[mysql]
default-character-set=utf8mb4
</code></pre></div><p>重新启动容器</p> <div class="language- extra-class"><pre class="language-text"><code>docker restart mysql
</code></pre></div><p>进入容器：</p> <div class="language- extra-class"><pre class="language-text"><code>docker exec -it mysql bash
</code></pre></div><p>在宿主机上登陆mysql：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#登录mysql</span>
mysql -h192.168.56.100 -p3306 -uroot -p123456

<span class="token comment">#添加远程登录用户</span>
CREATE USER <span class="token string">'test'</span>@<span class="token string">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">'123456'</span><span class="token punctuation">;</span>
GRANT ALL PRIVILEGES ON *.* TO <span class="token string">'test'</span>@<span class="token string">'%'</span><span class="token punctuation">;</span>

<span class="token comment">#查看编码</span>
showvariables like <span class="token string">&quot;%char%&quot;</span><span class="token punctuation">;</span>

flush privileges<span class="token punctuation">;</span>
</code></pre></div><h3 id="使用docker-compose安装"><a href="#使用docker-compose安装" aria-hidden="true" class="header-anchor">#</a> 使用docker-compose安装</h3> <p>docker-compose.yml配置文件如下：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">db</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mysql 
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span><span class="token punctuation">-</span>default<span class="token punctuation">-</span>authentication<span class="token punctuation">-</span>plugin=mysql_native_password
      <span class="token punctuation">-</span><span class="token punctuation">-</span>character<span class="token punctuation">-</span>set<span class="token punctuation">-</span>server=utf8mb4
      <span class="token punctuation">-</span><span class="token punctuation">-</span>collation<span class="token punctuation">-</span>server=utf8mb4_general_ci
      <span class="token punctuation">-</span><span class="token punctuation">-</span>explicit_defaults_for_timestamp=true
      <span class="token punctuation">-</span><span class="token punctuation">-</span>lower_case_table_names=1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 3306<span class="token punctuation">:</span><span class="token number">3306</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/mysql/conf<span class="token punctuation">:</span>/etc/mysql
      <span class="token punctuation">-</span> /data/docker/mysql/logs<span class="token punctuation">:</span>/var/log/mysql 
      <span class="token punctuation">-</span> /data/docker/mysql/data<span class="token punctuation">:</span>/var/lib/mysql
</code></pre></div><h2 id="安装redis"><a href="#安装redis" aria-hidden="true" class="header-anchor">#</a> 安装Redis</h2> <h3 id="docker安装-4"><a href="#docker安装-4" aria-hidden="true" class="header-anchor">#</a> docker安装</h3> <p>1、下载镜像</p> <div class="language- extra-class"><pre class="language-text"><code>docker pull  redis
</code></pre></div><p>2、运行容器</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -d --name redis -p 6379:6379 \
  -v /data/docker/redis/data:/data \
  -v /data/docker/redis/conf/redis.conf:/etc/redis/redis.conf \
  --privileged<span class="token operator">=</span>true redis:latest --appendonly <span class="token function">yes</span> --requirepass <span class="token string">&quot;123456&quot;</span> 
</code></pre></div><blockquote><p>注意：/etc/redis/redis.conf 是个目录</p></blockquote> <p>创建目录：</p> <div class="language- extra-class"><pre class="language-text"><code>mkdir /data/docker/redis/data

mkdir /data/docker/redis/conf
</code></pre></div><p>创建 /data/docker/redis/conf/redis.conf</p> <div class="language- extra-class"><pre class="language-text"><code>bind 0.0.0.0
protected-mode no
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300
</code></pre></div><p>3、查看容器</p> <div class="language- extra-class"><pre class="language-text"><code>docker ps
</code></pre></div><p>4、开发端口</p> <div class="language-bash extra-class"><pre class="language-bash"><code>firewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span>6379/tcp --permanent
</code></pre></div><p>5、进入容器</p> <div class="language- extra-class"><pre class="language-text"><code>docker exec -it redis redis-cli -h 192.168.56.100 -p 6379 -a '123456'
</code></pre></div><h3 id="docker-compose安装-4"><a href="#docker-compose安装-4" aria-hidden="true" class="header-anchor">#</a> docker-compose安装</h3> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">db</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server /etc/redis/redis.conf <span class="token punctuation">-</span><span class="token punctuation">-</span>requirepass 123456
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 6379<span class="token punctuation">:</span><span class="token number">6379</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/redis/data<span class="token punctuation">:</span>/data
      <span class="token punctuation">-</span> /data/docker/redis/conf/redis.conf<span class="token punctuation">:</span>/etc/redis/redis.conf
</code></pre></div><h3 id="集群安装"><a href="#集群安装" aria-hidden="true" class="header-anchor">#</a> 集群安装</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">master</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>master
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 6379<span class="token punctuation">:</span><span class="token number">6379</span>

  <span class="token key atrule">slave1</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>slave<span class="token punctuation">-</span><span class="token number">1</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 6380<span class="token punctuation">:</span><span class="token number">6379</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>slaveof redis<span class="token punctuation">-</span>master 6379

  <span class="token key atrule">slave2</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>slave<span class="token punctuation">-</span><span class="token number">2</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 6381<span class="token punctuation">:</span><span class="token number">6379</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>slaveof redis<span class="token punctuation">-</span>master 6379

  <span class="token key atrule">sentinel1</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span><span class="token number">1</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 26379<span class="token punctuation">:</span><span class="token number">26379</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sentinel /data/docker/redis/conf/sentinel.conf
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/redis/conf/sentinel1.conf<span class="token punctuation">:</span>/usr/local/etc/redis/sentinel.conf

  <span class="token key atrule">sentinel2</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span><span class="token number">2</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 26380<span class="token punctuation">:</span><span class="token number">26379</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sentinel /usr/local/etc/redis/sentinel.conf
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/redis/conf/sentinel2.conf<span class="token punctuation">:</span>/usr/local/etc/redis/sentinel.conf

  <span class="token key atrule">sentinel3</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span><span class="token number">3</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 26381<span class="token punctuation">:</span><span class="token number">26379</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sentinel /usr/local/etc/redis/sentinel.conf
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/redis/conf/sentinel3.conf<span class="token punctuation">:</span>/usr/local/etc/redis/sentinel.conf
</code></pre></div><p>sentinel.conf</p> <div class="language-text extra-class"><pre class="language-text"><code>port 26379
dir /tmp
# 自定义集群名，其中 127.0.0.1 为 redis-master 的 ip，6379 为 redis-master 的端口，2 为最小投票数（因为有 3 台 Sentinel 所以可以设置成 2）
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
sentinel deny-scripts-reconfig yes
</code></pre></div><h2 id="安装rabbitmq"><a href="#安装rabbitmq" aria-hidden="true" class="header-anchor">#</a> 安装RabbitMQ</h2> <h3 id="docker安装-5"><a href="#docker安装-5" aria-hidden="true" class="header-anchor">#</a> docker安装</h3> <p>获取rabbit镜像：</p> <div class="language- extra-class"><pre class="language-text"><code>docker pull rabbitmq:management
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>firewall-cmd --zone=public --add-port=5672/tcp --permanent
firewall-cmd --zone=public --add-port=15672/tcp --permanent
</code></pre></div><p>创建并运行容器：</p> <div class="language- extra-class"><pre class="language-text"><code>docker run -d --name rabbitmq -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=123456 -p 15672:15672 -p 5672:5672 --restart=always rabbitmq:management
</code></pre></div><p>容器运行正常，使用http://192.168.56.100:15672访问rabbit控制台，用户名和密码admin和123456。</p> <p>cshop-sms使用：</p> <ul><li>在管理界面添加一个虚拟主机/chsop，添加一个交换机cshop.sms.exchange，添加一个队里cshop.sms.queue，然后交换机绑定虚拟主机和队列。</li></ul> <p>cshop-email使用：</p> <h3 id="docker-compose安装-5"><a href="#docker-compose安装-5" aria-hidden="true" class="header-anchor">#</a> docker-compose安装</h3> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nexus</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">:</span>management
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> rabbitmq
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">RABBITMQ_DEFAULT_USER</span><span class="token punctuation">:</span> cshop
      <span class="token key atrule">RABBITMQ_DEFAULT_PASS</span><span class="token punctuation">:</span> cshop
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 15672<span class="token punctuation">:</span><span class="token number">15672</span>
      <span class="token punctuation">-</span> 5672<span class="token punctuation">:</span><span class="token number">5672</span>
</code></pre></div><h2 id="安装nginx"><a href="#安装nginx" aria-hidden="true" class="header-anchor">#</a> 安装Nginx</h2> <h3 id="docker-compose安装-6"><a href="#docker-compose安装-6" aria-hidden="true" class="header-anchor">#</a> docker compose安装</h3> <p>创建目录：</p> <div class="language- extra-class"><pre class="language-text"><code>mkdir -p /data/docker/nginx/wwwroot/html80

mkdir -p /data/docker/nginx/wwwroot/html8080

mkdir -p /data/docker/nginx/conf
</code></pre></div><p>修改 <code>/data/docker/nginx/conf/nginx.conf</code> 目录下的 nginx.conf</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 4180<span class="token punctuation">:</span><span class="token number">80</span>
      <span class="token punctuation">-</span> 4181<span class="token punctuation">:</span><span class="token number">8080</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/nginx/conf/nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
      <span class="token punctuation">-</span> /data/docker/nginx/wwwroot<span class="token punctuation">:</span>/usr/share/nginx/wwwroot
</code></pre></div><p>nginx.conf</p> <div class="language- extra-class"><pre class="language-text"><code>worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    
    keepalive_timeout  65;
    server {
        listen       80;
        server_name  static.cshop.com;
				# 所有的请求都以 / 开始，所有的请求都可以匹配此 location
        location / {
            root   /usr/share/nginx/wwwroot/html80;
            index  index.html index.htm;
        }
    }
    server {
        listen       8080;
        server_name  admin.cshop.com;

        location / {
            root   /usr/share/nginx/wwwroot/html8080;
            index  index.html index.htm;
        }
    }
}
</code></pre></div><p>配置hosts：</p> <div class="language- extra-class"><pre class="language-text"><code>192.168.56.100 admin.cshop.com

192.168.56.100 static.cshop.com
</code></pre></div><h3 id="docker-compose安装-7"><a href="#docker-compose安装-7" aria-hidden="true" class="header-anchor">#</a> docker-compose安装</h3> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 4000<span class="token punctuation">:</span><span class="token number">80</span>
      <span class="token punctuation">-</span> 4001<span class="token punctuation">:</span><span class="token number">8080</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/nginx/conf/nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
      <span class="token punctuation">-</span> /data/docker/nginx/wwwroot<span class="token punctuation">:</span>/usr/share/nginx/wwwroot
</code></pre></div><h2 id="安装elasticsearch"><a href="#安装elasticsearch" aria-hidden="true" class="header-anchor">#</a> 安装ElasticSearch</h2> <div class="language- extra-class"><pre class="language-text"><code>version: '3.3'
services:
  elasticsearch:
    image: elasticsearch:6.4.3
    container_name: elasticsearch
    restart: always
    ports:
      - 9200:9200
      - 9300:9300
    environment:
      cluster.name: elasticsearch
    volumes:
      - /data/docker/elasticsearch/data:/usr/share/elasticsearch/data
      - /data/docker/elasticsearch/plugins:/usr/share/elasticsearch/plugins
</code></pre></div><p><strong>集成IK分词器</strong></p> <div class="language- extra-class"><pre class="language-text"><code>wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.4.3/elasticsearch-analysis-ik-6.4.3.zip 
</code></pre></div><p>解压：</p> <div class="language- extra-class"><pre class="language-text"><code>unzip elasticsearch-analysis-ik-6.4.3 -d  analysis-ik
</code></pre></div><p>拷贝到插件目录</p> <div class="language- extra-class"><pre class="language-text"><code>cp -r analysis-ik plugins
</code></pre></div><p><strong>集成拼音分词器</strong></p> <div class="language- extra-class"><pre class="language-text"><code>wget https://github.com/medcl/elasticsearch-analysis-pinyin/releases/download/v6.4.3/elasticsearch-analysis-pinyin-6.4.3.zip
</code></pre></div><p>解压：</p> <div class="language- extra-class"><pre class="language-text"><code>unzip elasticsearch-analysis-pinyin-6.4.3 -d  analysis-pinyin
</code></pre></div><p>拷贝到插件目录</p> <div class="language- extra-class"><pre class="language-text"><code>cp -r analysis-pinyin plugins
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/wiki/spring-cloud-cshop/cshop-1-技术架构.html" class="prev">
          技术架构
        </a></span> <span class="next"><a href="/wiki/spring-cloud-cshop/cshop-3-准备开发环境.html">
          准备开发环境
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/wiki/assets/js/app.dd178f5a.js" defer></script><script src="/wiki/assets/js/2.9f273a62.js" defer></script><script src="/wiki/assets/js/54.87a1d37c.js" defer></script>
  </body>
</html>
