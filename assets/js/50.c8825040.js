(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{232:function(e,t,s){"use strict";s.r(t);var n=s(0),a=Object(n.a)({},function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"redis-ha-方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redis-ha-方案","aria-hidden":"true"}},[e._v("#")]),e._v(" Redis HA 方案")]),e._v(" "),s("h2",{attrs:{id:"概述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#概述","aria-hidden":"true"}},[e._v("#")]),e._v(" 概述")]),e._v(" "),s("p",[e._v("HA(High Available，高可用性群集)机集群系统简称，是保证业务连续性的有效解决方案，一般有两个或两个以上的节点，且分为活动节点及备用节点。通常把正在执 行业务的称为活动节点，而作为活动节点的一个备份的则称为备用节点。当活动节点出现问题，导致正在运行的业务（任务）不能正常运行时，备用节点此时就会侦测到，并立即接续活动节点来执行业务。从而实现业务的不中断或短暂中断。")]),e._v(" "),s("p",[e._v("Redis 一般以主/从方式部署（这里讨论的应用从实例主要用于备份，主实例提供读写）该方式要实现 HA 主要有如下几种方案：")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("keepalived：")]),e._v(" 通过 keepalived 的虚拟 IP，提供主从的统一访问，在主出现问题时， 通过 keepalived 运行脚本将从提升为主，待主恢复后先同步后自动变为主，该方案的好处是主从切换后，应用程序不需要知道(因为访问的虚拟 IP 不变)，坏处是引入 keepalived 增加部署复杂性，在有些情况下会导致数据丢失")]),e._v(" "),s("li",[s("strong",[e._v("zookeeper：")]),e._v(" 通过 zookeeper 来监控主从实例， 维护最新有效的 IP， 应用通过 zookeeper 取得 IP，对 Redis 进行访问，该方案需要编写大量的监控代码")]),e._v(" "),s("li",[s("strong",[e._v("sentinel：")]),e._v(" 通过 Sentinel 监控主从实例，自动进行故障恢复，该方案有个缺陷：因为主从实例地址( IP & PORT )是不同的，当故障发生进行主从切换后，应用程序无法知道新地址，故在 Jedis2.2.2 中新增了对 Sentinel 的支持，应用通过 "),s("code",[e._v("redis.clients.jedis.JedisSentinelPool.getResource()")]),e._v(" 取得的 Jedis 实例会及时更新到新的主实例地址")])]),e._v(" "),s("p",[s("img",{attrs:{src:"http://ww4.sinaimg.cn/large/006tNc79gy1g5585lv95gj30ne0fyq6a.jpg",alt:"部署逻辑图"}})]),e._v(" "),s("p",[s("strong",[e._v("注意：")]),e._v(" sentinel 是解决 HA 问题的，cluster 是解决主从复制问题的，不重复，并且经常一起用")]),e._v(" "),s("h2",{attrs:{id:"redis-sentinel-集群部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel-集群部署","aria-hidden":"true"}},[e._v("#")]),e._v(" Redis Sentinel 集群部署")]),e._v(" "),s("p",[e._v("Redis 集群可以在一组 redis 节点之间实现高可用性和 sharding。在集群中会有 1 个 master 和多个 slave 节点。当 master 节点失效时，应选举出一个 slave 节点作为新的 master。然而 Redis 本身(包括它的很多客户端)没有实现自动故障发现并进行主备切换的能力，需要外部的监控方案来实现自动故障恢复。")]),e._v(" "),s("p",[e._v("Redis Sentinel 是官方推荐的高可用性解决方案。它是 Redis 集群的监控管理工具，可以提供节点监控、通知、自动故障恢复和客户端配置发现服务。")]),e._v(" "),s("p",[s("img",{attrs:{src:"http://ww2.sinaimg.cn/large/006tNc79gy1g5586g3dyoj30ic07e403.jpg",alt:"img"}})]),e._v(" "),s("h3",{attrs:{id:"搭建-redis-集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建-redis-集群","aria-hidden":"true"}},[e._v("#")]),e._v(" 搭建 Redis 集群")]),e._v(" "),s("p",[e._v("搭建一主两从环境，docker-compose.yml 配置如下：")]),e._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("version: '3.1'\nservices:\n  master:\n    image: redis\n    container_name: redis-master\n    ports:\n      - 6379:6379\n\n  slave1:\n    image: redis\n    container_name: redis-slave-1\n    ports:\n      - 6380:6379\n    command: redis-server --slaveof redis-master 6379\n\n  slave2:\n    image: redis\n    container_name: redis-slave-2\n    ports:\n      - 6381:6379\n    command: redis-server --slaveof redis-master 6379\n")])])]),s("h3",{attrs:{id:"搭建-sentinel-集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建-sentinel-集群","aria-hidden":"true"}},[e._v("#")]),e._v(" 搭建 Sentinel 集群")]),e._v(" "),s("p",[e._v("我们至少需要创建三个 Sentinel 服务，docker-compose.yml 配置如下：")]),e._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'3.1'")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("sentinel1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" redis\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("sentinel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" 26379"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("26379")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("sentinel /usr/local/etc/redis/sentinel.conf\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" /data/sentinel/sentinel1.conf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("/usr/local/etc/redis/sentinel.conf\n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("sentinel2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" redis\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("sentinel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" 26380"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("26379")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("sentinel /usr/local/etc/redis/sentinel.conf\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" /data/sentinel/sentinel2.conf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("/usr/local/etc/redis/sentinel.conf\n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("sentinel3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" redis\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("sentinel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" 26381"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("26379")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("sentinel /usr/local/etc/redis/sentinel.conf\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" /data/sentinel/sentinel3.conf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("/usr/local/etc/redis/sentinel.conf\n")])])]),s("h3",{attrs:{id:"修改-sentinel-配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改-sentinel-配置文件","aria-hidden":"true"}},[e._v("#")]),e._v(" 修改 Sentinel 配置文件")]),e._v(" "),s("p",[e._v("/data/sentinel目录下需要三份 sentinel.conf 配置文件，分别为 "),s("code",[e._v("sentinel1.conf")]),e._v("，"),s("code",[e._v("sentinel2.conf")]),e._v("，"),s("code",[e._v("sentinel3.conf")]),e._v("，配置文件内容相同")]),e._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("port 26379\ndir /tmp\n# 自定义集群名，其中 127.0.0.1 为 redis-master 的 ip，6379 为 redis-master 的端口，2 为最小投票数（因为有 3 台 Sentinel 所以可以设置成 2）\nsentinel monitor mymaster 127.0.0.1 6379 2\nsentinel down-after-milliseconds mymaster 30000\nsentinel parallel-syncs mymaster 1\nsentinel failover-timeout mymaster 180000\nsentinel deny-scripts-reconfig yes\n")])])]),s("h3",{attrs:{id:"查看集群是否生效"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看集群是否生效","aria-hidden":"true"}},[e._v("#")]),e._v(" 查看集群是否生效")]),e._v(" "),s("p",[e._v("进入 Sentinel 容器，使用 Sentinel API 查看监控情况：")]),e._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("docker exec -it redis-sentinel-1 /bin/bash\nredis-cli -p 26379\nsentinel master mymaster\nsentinel slaves mymaster\n")])])])])},[],!1,null,null,null);t.default=a.exports}}]);